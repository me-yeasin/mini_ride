<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mini Ride | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        color-scheme: dark;
      }

      .surface-card {
        border: 1px solid rgba(148, 163, 184, 0.18);
        background: linear-gradient(155deg, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.6));
        box-shadow: 0 32px 80px -40px rgba(56, 189, 248, 0.4);
        backdrop-filter: blur(24px);
      }

      .surface-panel {
        border: 1px solid rgba(148, 163, 184, 0.12);
        background: linear-gradient(160deg, rgba(15, 23, 42, 0.88), rgba(15, 23, 42, 0.64));
        box-shadow: 0 24px 60px -32px rgba(15, 118, 230, 0.32);
        backdrop-filter: blur(18px);
      }

      .primary-btn {
        background: linear-gradient(120deg, #0ea5e9, #38bdf8);
        color: #0f172a;
        font-weight: 600;
        letter-spacing: 0.02em;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
      }

      .primary-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 30px 70px -25px rgba(14, 165, 233, 0.55);
        cursor: pointer;
      }

      .logout-btn {
        background: linear-gradient(135deg, #f97316, #f56565);
        color: #0f172a;
        font-weight: 600;
        letter-spacing: 0.02em;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 26px 60px -28px rgba(249, 115, 22, 0.55);
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100">
    {% if toast_message %}
    <div id="toast" class="fixed top-6 right-6 z-50 flex items-start gap-3 rounded-2xl border border-emerald-400/40 bg-emerald-500/15 px-5 py-4 text-sm text-emerald-100 shadow-lg shadow-emerald-500/30">
      <div class="mt-1 h-2 w-2 flex-none rounded-full bg-emerald-300"></div>
      <div>
        <p class="font-semibold">Request submitted</p>
        <p class="text-emerald-200/80">{{ toast_message }}</p>
      </div>
      <button id="toast-close" class="ml-4 text-xs font-semibold uppercase tracking-wide text-emerald-200/80 hover:text-white">Dismiss</button>
    </div>
    {% endif %}
    <div class="absolute inset-0 overflow-hidden">
      <div class="absolute left-[10%] top-[-12rem] h-[26rem] w-[26rem] rounded-full bg-sky-500/10 blur-3xl"></div>
      <div class="absolute right-[-8rem] bottom-[-8rem] h-[30rem] w-[30rem] rounded-full bg-emerald-500/10 blur-3xl"></div>
    </div>

    <main class="relative mx-auto flex min-h-screen max-w-6xl flex-col gap-12 px-6 py-16 lg:px-10">
      <header class="flex flex-col gap-6 rounded-3xl surface-card p-8 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.3em] text-sky-300">
            {{ "Rider" if role_key == "rider" else "Community" }} portal
          </p>
          <h1 class="mt-3 text-3xl font-semibold text-white sm:text-4xl">
            {% if role_key == "rider" %}
            Hello {{ account.name or "there" }}, ready for your next pickup?
            {% else %}
            Welcome back {{ account.name or "there" }}, keep your riders energized.
            {% endif %}
          </h1>
          <p class="mt-3 text-sm text-slate-300">
            {{ hero_message }}
          </p>
        </div>
        <div class="flex flex-col gap-3 sm:items-end">
          {% if state == "signup" %}
          <span class="rounded-full bg-emerald-500/20 px-5 py-2 text-sm font-semibold text-emerald-200">Account created</span>
          {% elif state == "login" %}
          <span class="rounded-full bg-sky-500/20 px-5 py-2 text-sm font-semibold text-sky-200">Logged in</span>
          {% endif %}
          <a href="{{ url_for('logout') }}" class="logout-btn inline-flex items-center gap-2 rounded-full px-6 py-2 text-sm">
            <span class="inline-flex h-6 w-12 items-center justify-center rounded-full bg-white/25 text-xs font-semibold text-white">⇦</span>
            <span class="text-xs font-semibold uppercase tracking-wide text-white w-full">Log out</span>
          </a>
        </div>
      </header>

      {% if role_key == "rider" %}
      <section class="grid gap-6 sm:grid-cols-3">
        <article class="rounded-2xl surface-panel p-6">
          <p class="text-xs uppercase tracking-widest text-slate-400">Pending requests</p>
          <p class="mt-3 text-3xl font-semibold text-white">{{ pending_count }}</p>
          <p class="mt-1 text-xs text-slate-400">Awaiting your response</p>
        </article>
        <article class="rounded-2xl surface-panel p-6">
          <p class="text-xs uppercase tracking-widest text-slate-400">Accepted rides</p>
          <p class="mt-3 text-3xl font-semibold text-white">{{ accepted_count }}</p>
          <p class="mt-1 text-xs text-slate-400">Passengers already notified</p>
        </article>
        <article class="rounded-2xl surface-panel p-6">
          <p class="text-xs uppercase tracking-widest text-slate-400">Your email</p>
          <p class="mt-3 text-lg font-semibold text-white">{{ account.email }}</p>
          <p class="mt-1 text-xs text-slate-400">Ride alerts land here</p>
        </article>
      </section>

      <section id="rider-dashboard" class="rounded-3xl surface-card p-8" data-initial-tab="{{ active_tab }}">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-2xl font-semibold text-white">Rider tools</h2>
            <p class="mt-1 text-sm text-slate-300">Review passenger requests or ask for coverage when you need a lift.</p>
          </div>
          <div class="inline-flex rounded-full border border-slate-700 p-1">
            <button id="rider-tab-requests" class="tab-button rounded-full px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-sky-500/30">Passenger requests</button>
            <button id="rider-tab-form" class="tab-button rounded-full px-4 py-2 text-sm font-semibold text-slate-300 hover:text-white">Request a ride</button>
          </div>
        </div>
        <div class="mt-8">
          <div id="rider-panel-requests" class="tab-panel space-y-6">
            <div class="overflow-hidden rounded-2xl border border-white/5">
              <table class="min-w-full divide-y divide-white/5">
                <thead class="bg-slate-900/60 text-left text-xs uppercase tracking-widest text-slate-400">
                  <tr>
                    <th class="px-6 py-3 font-medium">Passenger</th>
                    <th class="px-6 py-3 font-medium">Pickup</th>
                    <th class="px-6 py-3 font-medium">Destination</th>
                    <th class="px-6 py-3 font-medium">Status</th>
                    <th class="px-6 py-3 font-medium">Requested</th>
                    <th class="px-6 py-3 font-medium text-right">Actions</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-white/5 bg-slate-950/50 text-sm text-slate-200">
                  {% if rider_requests %}
                  {% for ride in rider_requests %}
                  <tr class="hover:bg-slate-900/60">
                    <td class="px-6 py-4 font-semibold text-white">{{ ride.passenger_name }}</td>
                    <td class="px-6 py-4">{{ ride.pickup }}</td>
                    <td class="px-6 py-4">{{ ride.destination }}</td>
                    <td class="px-6 py-4">
                      <span class="rounded-full bg-white/5 px-3 py-1 text-xs uppercase tracking-wide">{{ ride.status }}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-400">
                      {% if ride.created_at %}
                      {{ ride.created_at.strftime("%b %d, %Y %I:%M %p") }}
                      {% else %}
                      —
                      {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right">
                      <div class="flex justify-end gap-3">
                        <form method="post" action="{{ url_for('approve_request', request_id=ride.id_str) }}" class="js-inline-submit">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                          <button type="submit" data-loading-label="Approving..." class="rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold text-emerald-950 transition hover:bg-emerald-400 disabled:cursor-not-allowed disabled:opacity-40" {% if ride.status != 'pending' %}disabled{% endif %}>
                            Approve
                          </button>
                        </form>
                        <form method="post" action="{{ url_for('reject_request', request_id=ride.id_str) }}" class="js-inline-submit">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                          <button type="submit" data-loading-label="Declining..." class="rounded-full bg-rose-500 px-4 py-2 text-xs font-semibold text-rose-50 transition hover:bg-rose-400 disabled:cursor-not-allowed disabled:opacity-40" {% if ride.status != 'pending' %}disabled{% endif %}>
                            Decline
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                  {% else %}
                  <tr>
                    <td class="px-6 py-10 text-center text-sm text-slate-400" colspan="6">No passenger requests right now. You're all caught up.</td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>

          <div id="rider-panel-form" class="tab-panel hidden">
            <div class="grid gap-6 lg:grid-cols-[0.6fr_0.4fr]">
              <form method="post" action="{{ url_for('request_ride') }}" class="space-y-6">
                {{ request_form.hidden_tag() }}
                <div class="space-y-2">
                  {{ request_form.passenger_name.label(class_="text-sm font-medium text-slate-200") }}
                  {{ request_form.passenger_name(class_="input-field w-full rounded-xl bg-slate-900/60 border border-slate-700 px-4 py-3 text-base text-slate-100") }}
                  {% for error in request_form.passenger_name.errors %}
                  <p class="text-sm text-rose-400">{{ error }}</p>
                  {% endfor %}
                </div>
                <div class="space-y-2">
                  {{ request_form.passenger_email.label(class_="text-sm font-medium text-slate-200") }}
                  {{ request_form.passenger_email(class_="input-field w-full rounded-xl bg-slate-900/60 border border-slate-700 px-4 py-3 text-base text-slate-100") }}
                  {% for error in request_form.passenger_email.errors %}
                  <p class="text-sm text-rose-400">{{ error }}</p>
                  {% endfor %}
                </div>
                <div class="space-y-2">
                  {{ request_form.pickup.label(class_="text-sm font-medium text-slate-200") }}
                  {{ request_form.pickup(class_="input-field w-full rounded-xl bg-slate-900/60 border border-slate-700 px-4 py-3 text-base text-slate-100") }}
                  {% for error in request_form.pickup.errors %}
                  <p class="text-sm text-rose-400">{{ error }}</p>
                  {% endfor %}
                </div>
                <div class="space-y-2">
                  {{ request_form.destination.label(class_="text-sm font-medium text-slate-200") }}
                  {{ request_form.destination(class_="input-field w-full rounded-xl bg-slate-900/60 border border-slate-700 px-4 py-3 text-base text-slate-100") }}
                  {% for error in request_form.destination.errors %}
                  <p class="text-sm text-rose-400">{{ error }}</p>
                  {% endfor %}
                </div>
                {{ request_form.submit(class_="primary-btn w-full rounded-full px-6 py-3 text-base") }}
              </form>
              <div class="rounded-3xl surface-panel p-6">
                <h3 class="text-lg font-semibold text-white">Need backup?</h3>
                <ul class="mt-4 space-y-3 text-sm text-slate-300">
                  <li class="flex gap-3"><span class="mt-1 h-2 w-2 rounded-full bg-sky-400"></span>Request coverage when your vehicle is unavailable.</li>
                  <li class="flex gap-3"><span class="mt-1 h-2 w-2 rounded-full bg-emerald-400"></span>Nearby riders receive your request instantly.</li>
                  <li class="flex gap-3"><span class="mt-1 h-2 w-2 rounded-full bg-amber-400"></span>Track the status under the passenger requests tab.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>
      {% else %}
      <section id="member-dashboard" class="rounded-3xl surface-card p-8" data-initial-tab="{{ active_tab }}">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-2xl font-semibold text-white">Passenger tools</h2>
            <p class="mt-1 text-sm text-slate-300">Review your recent ride requests or send a new one in seconds.</p>
          </div>
          <div class="inline-flex rounded-full border border-slate-700 p-1">
            <button id="tab-list" class="tab-button rounded-full px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-sky-500/30">My requests</button>
            <button id="tab-form" class="tab-button rounded-full px-4 py-2 text-sm font-semibold text-slate-300 hover:text-white">Request a ride</button>
          </div>
        </div>
        <div class="mt-8">
          <div id="panel-list" class="tab-panel space-y-6">
            <div class="grid gap-6 sm:grid-cols-3">
              <article class="rounded-2xl surface-panel p-6">
                <p class="text-xs uppercase tracking-widest text-slate-400">Pending rides</p>
                <p class="mt-3 text-3xl font-semibold text-white">{{ pending_count }}</p>
                <p class="mt-1 text-xs text-slate-400">Waiting for rider confirmation</p>
              </article>
              <article class="rounded-2xl surface-panel p-6">
                <p class="text-xs uppercase tracking-widest text-slate-400">Accepted rides</p>
                <p class="mt-3 text-3xl font-semibold text-white">{{ accepted_count }}</p>
                <p class="mt-1 text-xs text-slate-400">Drivers already on their way</p>
              </article>
              <article class="rounded-2xl surface-panel p-6">
                <p class="text-xs uppercase tracking-widest text-slate-400">Total riders</p>
                <p class="mt-3 text-3xl font-semibold text-white">{{ total_riders }}</p>
                <p class="mt-1 text-xs text-slate-400">Supporting your community</p>
              </article>
            </div>
            <div class="overflow-hidden rounded-2xl border border-white/5">
              <table class="min-w-full divide-y divide-white/5">
                <thead class="bg-slate-900/60 text-left text-xs uppercase tracking-widest text-slate-400">
                  <tr>
                    <th class="px-6 py-3 font-medium">Pickup</th>
                    <th class="px-6 py-3 font-medium">Destination</th>
                    <th class="px-6 py-3 font-medium">Status</th>
                    <th class="px-6 py-3 font-medium">Requested</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-white/5 bg-slate-950/50 text-sm text-slate-200">
                  {% if member_requests %}
                  {% for ride in member_requests %}
                  <tr class="hover:bg-slate-900/60">
                    <td class="px-6 py-4 font-semibold text-white">{{ ride.pickup }}</td>
                    <td class="px-6 py-4">{{ ride.destination }}</td>
                    <td class="px-6 py-4">
                      <span class="rounded-full bg-white/5 px-3 py-1 text-xs uppercase tracking-wide">{{ ride.status }}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-400">
                      {% if ride.created_at %}
                      {{ ride.created_at.strftime("%b %d, %Y %I:%M %p") }}
                      {% else %}
                      —
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                  {% else %}
                  <tr>
                    <td class="px-6 py-10 text-center text-sm text-slate-400" colspan="4">No ride requests yet. Submit your first journey and we’ll notify nearby riders.</td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>

          <div id="panel-form" class="tab-panel hidden">
            <div class="grid gap-6 lg:grid-cols-[0.6fr_0.4fr]">
              <form method="post" action="{{ url_for('request_ride') }}" class="space-y-6">
                {{ request_form.hidden_tag() }}
                <div class="space-y-2">
                  {{ request_form.passenger_name.label(class_="text-sm font-medium text-slate-200") }}
                  {{ request_form.passenger_name(class_="input-field w-full rounded-xl bg-slate-900/60 border border-slate-700 px-4 py-3 text-base text-slate-100") }}
                  {% for error in request_form.passenger_name.errors %}
                  <p class="text-sm text-rose-400">{{ error }}</p>
                  {% endfor %}
                </div>
                <div class="space-y-2">
                  {{ request_form.passenger_email.label(class_="text-sm font-medium text-slate-200") }}
                  {{ request_form.passenger_email(class_="input-field w-full rounded-xl bg-slate-900/60 border border-slate-700 px-4 py-3 text-base text-slate-100") }}
                  {% for error in request_form.passenger_email.errors %}
                  <p class="text-sm text-rose-400">{{ error }}</p>
                  {% endfor %}
                </div>
                <div class="space-y-2">
                  {{ request_form.pickup.label(class_="text-sm font-medium text-slate-200") }}
                  {{ request_form.pickup(class_="input-field w-full rounded-xl bg-slate-900/60 border border-slate-700 px-4 py-3 text-base text-slate-100") }}
                  {% for error in request_form.pickup.errors %}
                  <p class="text-sm text-rose-400">{{ error }}</p>
                  {% endfor %}
                </div>
                <div class="space-y-2">
                  {{ request_form.destination.label(class_="text-sm font-medium text-slate-200") }}
                  {{ request_form.destination(class_="input-field w-full rounded-xl bg-slate-900/60 border border-slate-700 px-4 py-3 text-base text-slate-100") }}
                  {% for error in request_form.destination.errors %}
                  <p class="text-sm text-rose-400">{{ error }}</p>
                  {% endfor %}
                </div>
                {{ request_form.submit(class_="primary-btn w-full rounded-full px-6 py-3 text-base") }}
              </form>
              <div class="rounded-3xl surface-panel p-6">
                <h3 class="text-lg font-semibold text-white">How it works</h3>
                <ul class="mt-4 space-y-3 text-sm text-slate-300">
                  <li class="flex gap-3"><span class="mt-1 h-2 w-2 rounded-full bg-sky-400"></span>Submit your trip details to alert nearby riders instantly.</li>
                  <li class="flex gap-3"><span class="mt-1 h-2 w-2 rounded-full bg-emerald-400"></span>Riders receive the request and confirm availability.</li>
                  <li class="flex gap-3"><span class="mt-1 h-2 w-2 rounded-full bg-amber-400"></span>Check back here or on email for status updates and confirmations.</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>
      {% endif %}
    </main>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const setupTabs = (config) => {
          const container = document.getElementById(config.containerId);
          if (!container) return;
          const initialKey = (container.dataset.initialTab || config.defaultTab).toLowerCase();
          Object.entries(config.tabs).forEach(([key, value]) => {
            const button = document.getElementById(value.button);
            const panel = document.getElementById(value.panel);
            if (!button || !panel) return;
            button.addEventListener("click", () => activate(key));
          });

          const activate = (key) => {
            Object.entries(config.tabs).forEach(([tabKey, value]) => {
              const button = document.getElementById(value.button);
              const panel = document.getElementById(value.panel);
              if (!button || !panel) return;
              if (tabKey === key) {
                panel.classList.remove("hidden");
                button.classList.add("bg-sky-500", "text-slate-900", "shadow-lg", "shadow-sky-500/40");
                button.classList.remove("text-slate-300");
              } else {
                panel.classList.add("hidden");
                button.classList.remove("bg-sky-500", "text-slate-900", "shadow-lg", "shadow-sky-500/40");
                button.classList.add("text-slate-300");
              }
            });
          };

          activate(config.tabs[initialKey] ? initialKey : config.defaultTab);
        };

        setupTabs({
          containerId: "member-dashboard",
          defaultTab: "list",
          tabs: {
            list: { button: "tab-list", panel: "panel-list" },
            form: { button: "tab-form", panel: "panel-form" },
          },
        });

        setupTabs({
          containerId: "rider-dashboard",
          defaultTab: "requests",
          tabs: {
            requests: { button: "rider-tab-requests", panel: "rider-panel-requests" },
            form: { button: "rider-tab-form", panel: "rider-panel-form" },
          },
        });

        document.querySelectorAll("form.js-inline-submit").forEach((form) => {
          form.addEventListener("submit", () => {
            const button = form.querySelector("button[type='submit']");
            if (!button || button.disabled) return;
            const originalLabel = button.innerText.trim();
            const loadingLabel = button.dataset.loadingLabel || "Working...";
            button.dataset.originalLabel = originalLabel;
            button.innerText = loadingLabel;
            button.classList.add("opacity-60", "cursor-wait");
            button.disabled = true;
          });
        });

        const toast = document.getElementById("toast");
        const toastClose = document.getElementById("toast-close");
        if (toast && toastClose) {
          const hideToast = () => toast.classList.add("opacity-0", "pointer-events-none");
          toastClose.addEventListener("click", hideToast);
          setTimeout(hideToast, 4000);
        }
      });
    </script>
  </body>
</html>
